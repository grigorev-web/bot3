/**
 * @fileoverview –ü—Ä–æ—Å—Ç–æ–π —Ä–æ—É—Ç–µ—Ä —Å LLM
 * @description –°–æ–∑–¥–∞–µ—Ç LLM —Å–µ—Ä–≤–∏—Å, –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç
 * @author Telegram Bot Team
 * @version 4.1.0
 * @since 2024-01-01
 */

const { LLMService } = require('../../services/llm');

class Router {
  constructor(msg) {
    this.msg = msg;
  }

  /**
   * @group Text Processing
   * @description –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
   * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
   * @returns {Promise<string>} –û—Ç–≤–µ—Ç –æ—Ç LLM
   */
  async processText(text) {
    try {
      if (!text || typeof text !== 'string') {
        throw new Error('–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π');
      }

      console.log(`üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ LLM: "${text}"`);
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π LLM —Å–µ—Ä–≤–∏—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      const llmService = new LLMService();
      
      // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM
      const response = await llmService.generateResponse(text);
      if (response && response.content) {
        console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç LLM');
        return response.content;
      }
      
      // Fallback –µ—Å–ª–∏ LLM –Ω–µ –¥–∞–ª –æ—Ç–≤–µ—Ç
      console.log('‚ö†Ô∏è LLM –Ω–µ –¥–∞–ª –æ—Ç–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—é fallback');
      return this.getDefaultResponse(text);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞:', error);
      return this.getErrorResponse(error);
    }
  }

  /**
   * @group Fallback Responses
   * @description –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   * @param {string} text - –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {string} –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
   * @private
   */
  getDefaultResponse(text) {
    return `üìù –í—ã –Ω–∞–ø–∏—Å–∞–ª–∏: "${text}"\n\nüí° LLM —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
  }

  /**
   * @group Error Handling
   * @description –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
   * @param {Error} error - –û–±—ä–µ–∫—Ç –æ—à–∏–±–∫–∏
   * @returns {string} –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
   * @private
   */
  getErrorResponse(error) {
    return `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:\nüîç ${error.message}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`;
  }
}

module.exports = Router;
